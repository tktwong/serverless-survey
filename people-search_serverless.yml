# generated by @ng-toolkit/serverless
service: cok-people-search-frontend

plugins:
  - serverless-apigw-binary
  - serverless-apigwy-binary
  - serverless-plugin-include-dependencies
  - serverless-associate-waf
  - serverless-domain-manager


provider:
  name: aws
  runtime: nodejs10.x
  memorySize: 192
  timeout: 10
  stage: ${opt:stage, 'dev'}
  region: us-east-1
  environment:
    STAGE: ${self:provider.stage}
    MIX_PANEL_KEY: ${self:custom.mixpanel.${self:provider.stage}}
    AUTH0_DOMAIN: https://login.connectourkids.org/
    AUTH0_CLIENT_ID: ${self:custom.auth0ClientId.${self:provider.stage}}
    AUTH0_AUDIENCE: ${self:custom.auth0Audience.${self:provider.stage}}
  iamRoleStatements:
    - Effect: "Allow"
      Action:
        - "dynamodb:PutItem"
        - "dynamodb:GetItem"
        - "dynamodb:BatchWriteItem"
      Resource:
        - "arn:aws:dynamodb:us-east-1:*:table/pipl-cache"
        - "arn:aws:dynamodb:us-east-1:*:table/pipl-search-pointers"
    - Effect: "Allow"
      Action:
        - "ssm:DescribeParameters"
      Resource:
        Fn::Join:
          - ""
          - - "*"
    - Effect: "Allow"
      Action:
        - "ssm:GetParametersByPath"
      Resource:
        Fn::Join:
          - ""
          - - "arn:aws:ssm:us-east-1:*:parameter/pipl/"
    - Effect: "Allow"
      Action:
        - "ssm:GetParametersByPath"
        - "ssm:GetParameter"
      Resource:
        - "arn:aws:ssm:us-east-1:*:parameter/people-search/*"

package:
  exclude:
    - src/**
    - node_modules/**
    - firebug-lite/**
    - e2e/**
    - coverage/**
    - '!node_modules/aws-serverless-express/**'
    - '!node_modules/binary-case/**'
    - '!node_modules/type-is/**'
    - '!node_modules/media-typer/**'
    - '!node_modules/mime-types/**'
    - '!node_modules/mime-db/**'
  include:
    - test-data/**

custom:
  apigwBinary:
    types:
      - '*/*'
  stage: ${opt:stage, self:provider.stage}
  domains:
    production: search.connectourkids.org
    dev: dev.search.connectourkids.org
  customDomain:
    basePath: ""
    domainName: ${self:custom.domains.${self:custom.stage}}
    stage: "${self:custom.stage}"
    createRoute53Record: true
    certificateName: "search.connectourkids.org"
  mixpanel:
    production: ${ssm:/people-search/mixpanel/production-key~true}
    dev: ${ssm:/people-search/mixpanel/dev-key~true}
  associateWaf:
    name: us-vn-only
  auth0ClientId:
    production: i5NGofkl7Z4jEexA7YTbasrLT8pcKLDU
    dev: JUR6JVt9N4sn8bHrSXR818rwrj91hsTb
  auth0Audience:
    production: https://search.connectourkids.org/api/ https://family.connectourkids.org/api/v1 https://api.connectourkids.org/
    dev: https://dev.search.connectourkids.org/api/ https://family-staging.connectourkids.org/api/v1/ https://api-dev.connectourkids.org/ https://api-staging.connectourkids.org/
  auth0ManagementClientId:
    production: ${ssm:/people-search/auth0/management-client-secret~true}
    dev: ${ssm:/people-search/auth0/management-client-secret~true}


functions:
  ui:
    handler: lambda/ui.universal
    events:
      - http: ANY {proxy+}
      - http: ANY /
  searchv2:
    handler: lambda/search-v2.query
    events:
      - http:
          path: api/search-v2
          method: POST
          cors: true
          request:
            template:
              application/json: >
                {
                  "q" : "$input.params('q')"
                }
          response:
            headers:
              Content-Type: "application/json"
  query:
    handler: lambda/search.query
    events:
      - http:
          path: api/query
          method: POST
          cors: true
          request:
            template:
              application/json: >
                {
                  "q" : "$input.params('q')",
                  "location" : "$input.params('location')",
                }

          response:
            headers:
              Content-Type: "application/json"
  sendEvent:
    handler: lambda/analytics.sendEvent
    events:
      - http:
          path: api/sendEvent
          method: POST
          cors: true
  sendUserInfo:
    handler: lambda/analytics.sendUserInfo
    events:
      - http:
          path: api/sendUserInfo
          method: POST
          cors: true
  thumbnail:
    handler: lambda/search.thumbnail
    events:
      - http:
          path: api/thumbnail
          method: GET
          contentHandling: CONVERT_TO_BINARY
          request:
            template:
              application/json: >
                {
                  "tokens" : "$input.params('tokens')"
                }
  redirect:
    handler: lambda/redirect.redirect
    events:
      - http:
          path: api/redirect
          method: GET
          cors: true
