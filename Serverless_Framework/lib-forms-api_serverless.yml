#serverless.yml
service: formsli-integration
frameworkVersion: '>=1.5.0 <2.0.0'
provider:
  profile: fl-infrastructure
  name: aws
  stage: ${opt:stage, 'dev'}
  runtime: nodejs12.x
  region: ${opt:region, 'ap-northeast-1'}
  apiGateway:
    restApiId: ${ssm:/${self:provider.stage}/formsli/apig/restApiId}
    restApiRootResourceId: ${ssm:/${self:provider.stage}/formsli/apig/rootResourceId}
    restApiResources:
      /integration: ${ssm:/${self:provider.stage}/formsli/apig/resource/integration}
  logs:
    restApi:
      enableAccessLogging: true
      level: INFO
      dataTrace: true
  tracing: true
  memorySize: 512
  timeout: 30
  logRetentionInDays: 7
  stackTags:
    Application: formsli
    Environment: ${self:provider.stage}
    Stack      : ${self:service}
    Deployer   : "Serverless"
  deploymentBucket:
    name: fl-${self:provider.stage}-deployments # Deployment bucket name. Default is generated by the framework
    blockPublicAccess: true # Prevents public access via ACLs or bucket policies. Default is false
    serverSideEncryption: AES256
  functions:
    createUser             : ${self:service}-${self:provider.stage}-create-user
    listSolutions          : ${self:service}-${self:provider.stage}-list-solutions
    createSolutionInstance : ${self:service}-${self:provider.stage}-create-solution-instance
    listSolutionInstances  : ${self:service}-${self:provider.stage}-list-solution-instance
    updateSolutionInstance : ${self:service}-${self:provider.stage}-update-solution-instance
  environment:
    region          : ${self:provider.region}
    environment     : ${self:provider.stage}
    serviceName     : ${self:service}
    databaseName    : formsli
    dbClusterId     : ${ssm:/${self:provider.stage}/formsli/rds/id}
    dbClusterArn    : "arn:aws:rds:#{AWS::Region}:#{AWS::AccountId}:cluster:${self:provider.environment.dbClusterId}"
    dbClusterSecretArn : ${ssm:/${self:provider.stage}/formsli/rds/password/secret}
    vendorAccountId    : formsli
    vendorApiUrl       : https://tray.io/graphql
    vendorApiToken     : ${ssm:/${self:provider.stage}/formsli/vendor/tray/apiToken}
    graphqlApiId    : ${ssm:/${self:provider.stage}/formsli/graphql/api/id}
    graphqlApiUrl   : ${ssm:/${self:provider.stage}/formsli/graphql/api/url}
    graphqlApiKey   : ${ssm:/${self:provider.stage}/formsli/graphql/api/key}
  iamRoleStatements:
    - Effect: "Allow"
      Action:
        - "tag:GetResources"
        - "secretsmanager:CreateSecret"
        - "secretsmanager:ListSecrets"
        - "secretsmanager:GetRandomPassword"
        - "logs:CreateLogGroup"
        - "logs:CreateLogStream"
        - "logs:PutLogEvents"
        - "xray:PutTelemetryRecords"
        - "xray:PutTraceSegments"
      Resource:
        - "*"
    - Effect: "Allow"
      Action:
        - "ssm:GetParameter"
        - "ssm:GetParameters"
        - "ssm:GetParametersByPath"
      Resource:
        - "arn:aws:ssm:#{AWS::Region}:#{AWS::AccountId}:parameter/${self:provider.stage}/formsli/*"

plugins:
  - serverless-webpack
  - serverless-pseudo-parameters
  - serverless-iam-roles-per-function
  - serverless-plugin-tracing
  - serverless-plugin-aws-alerts
  - serverless-plugin-log-subscription
  - '@anttiviljami/serverless-stack-output'

custom:
  logSubscription:
    enabled: true
    destinationArn: ${ssm:/${self:provider.stage}/formsli/logging/destinationArn}
    roleArn: ${ssm:/${self:provider.stage}/formsli/logging/roleArn}
  alerts:
    dashboards: true
    stages:
      - dev # Disable later
      - staging
      - production
    topics:
      alarm:
        topic: ${self:service}-${self:provider.stage}-alerts-alarm
        notifications:
          - protocol: email
            endpoint: infrastructure.${self:provider.stage}@forms.li
    alarms:
      - functionErrors
      - functionThrottles
      - functionInvocations
      - functionDuration
  serverless-iam-roles-per-function:
    defaultInherit: true
  # Stack Output Plugin
  output:
    file: outputs/stack.${self:provider.stage}.json # toml, yaml, yml, and json format is available
  # Servlerless Webpack (for functions)
  packagePath: './package.json'
  webpack:
    webpackConfig: 'webpack.config.js'   # Name of webpack configuration file
    packager: 'npm'   # Packager that will be used to package your external modules
    includeModules:
      forceInclude:
        - source-map-support

functions:
  createUser :
    name: ${self:provider.functions.createUser}
    handler: functions/createUser.handle
    events:
      - http:
          path  : /integration/createUser/{tenantId}
          method: PUT
          cors  : true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              ${ssm:/${self:provider.stage}/formsli/apig/authorizerId}
            claims:
              - email
              - username
              - custom:tenantId
              - custom:group
    iamRoleStatements:
      - Effect: "Allow"
        Action:
          - "secretsmanager:GetSecretValue"
        Resource:
          - "arn:aws:secretsmanager:ap-northeast-1:#{AWS::AccountId}:secret:/${self:provider.stage}/formsli/rds/*"
      - Effect: "Allow"
        Action:
          - "rds-data:BeginTransaction"
          - "rds-data:CommitTransaction"
          - "rds-data:ExecuteStatement"
          - "rds-data:RollbackTransaction"
        Resource:
          - "${self:provider.environment.dbClusterArn}"
          - "${self:provider.environment.dbClusterArn}:*"
  listSolutions :
    name: ${self:provider.functions.listSolutions}
    handler: functions/listSolutions.handle
    events:
      - http:
          path  : /integration/listSolutions
          method: POST
          cors  : true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              ${ssm:/${self:provider.stage}/formsli/apig/authorizerId}
            claims:
              - email
              - username
              - custom:tenantId
              - custom:group
  createSolutionInstance :
    name: ${self:provider.functions.createSolutionInstance}
    handler: functions/createSolutionInstance.handle
    events:
      - http:
          path  : /integration/createSolutionInstance
          method: POST
          cors  : true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              ${ssm:/${self:provider.stage}/formsli/apig/authorizerId}
            claims:
              - email
              - username
              - custom:tenantId
              - custom:group
    iamRoleStatements:
      - Effect: "Allow"
        Action:
          - "secretsmanager:GetSecretValue"
        Resource:
          - "arn:aws:secretsmanager:ap-northeast-1:#{AWS::AccountId}:secret:/${self:provider.stage}/formsli/rds/*"
      - Effect: "Allow"
        Action:
          - "rds-data:BeginTransaction"
          - "rds-data:CommitTransaction"
          - "rds-data:ExecuteStatement"
          - "rds-data:RollbackTransaction"
        Resource:
          - "${self:provider.environment.dbClusterArn}"
          - "${self:provider.environment.dbClusterArn}:*"
  updateSolutionInstance :
    name: ${self:provider.functions.updateSolutionInstance}
    handler: functions/updateSolutionInstance.handle
    events:
      - http:
          path  : /integration/updateSolutionInstance
          method: POST
          cors  : true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              ${ssm:/${self:provider.stage}/formsli/apig/authorizerId}
            claims:
              - email
              - username
              - custom:tenantId
              - custom:group
  listSolutionInstances :
    name: ${self:provider.functions.listSolutionInstances}
    handler: functions/listSolutionInstances.handle
    events:
      - http:
          path  : /integration/listSolutionInstances
          method: POST
          cors  : true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              ${ssm:/${self:provider.stage}/formsli/apig/authorizerId}
            claims:
              - email
              - username
              - custom:tenantId
              - custom:group