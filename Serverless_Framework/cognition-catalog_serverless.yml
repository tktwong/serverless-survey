service: cognition-catalog
provider:
  name: aws
  region: us-east-1
  runtime: python3.6
  iamRoleStatementsName: cognition-catalog-role
  iamRoleStatements:
    - Action:
        - sns:*
        - sqs:*

functions:

  # Build the root STAC catalog (with collections for each datasource specified in config).
  # Ingest root level catalog / collections into sat-api.
  setup:
    handler: handler.setup

  # Unpacks STAC Items generated queries to cognition-datasources and sends to SQS queue.
  # 1 message = 1 STAC Item.
  worker:
    handler: handler.worker

  # Consumes STAC Items generated by cognition-datasources (via SQS).
  # Update the `links` property to place the item within a collection.
  # Sends resolved items to NewSTACItemTopic, triggering sat-api ingest via SNS.
  ingestStacItem:
    handler: handler.ingest_stac_item
    events:
      - sns:
          arn: aws:sqs:${self:provider:region}:#{AWS::AccountId}:NewSTACItemTopic-${self:provider:stage}

resources:
  Resources:

    NewSTACItemTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: NewSTACItemTopic-${self:provider:stage}

    NewSTACItemQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: NewSTACItemQueue-${self:provider:stage}

plugins:
  - serverless-pseudo-parameters