
#================================================================
# This project was generated by Serverless HQ:
# Your home base for powerfully easy Serverless scaffolding.
# Made in knoxville, tn by haseebnqureshi (_hq)
#================================================================

frameworkVersion: ">=1.6.0 <2.0.0"

service: blocky-backend

provider:
  name: aws
  runtime: nodejs6.10
  stage: dev
  region: us-east-1
  profile: default
  versionFunctions: false
  iamRoleStatements:

    # Lambda iam role permissions onto dynamodb
    - Effect: Allow
      Action:
        - dynamodb:*
      Resource: arn:aws:dynamodb:*:*:*

  apiKeys:
    - ${opt:stage, self:provider.stage}-blocky-brokerAPIKey

  environment:

    # Project environment variables
    SERVICE: blocky_backend
    PROVIDER_NAME: aws
    PROVIDER_RUNTIME: nodejs6.10
    PROVIDER_STAGE: dev
    PROVIDER_REGION: us-east-1
    PROVIDER_PROFILE: default

    USERS_TABLE_NAME: ${self:service}-${opt:stage, self:provider.stage}-users
    DEVICES_TABLE_NAME: ${self:service}-${opt:stage, self:provider.stage}-devices-v2
    SCRIPTS_TABLE_NAME: ${self:service}-${opt:stage, self:provider.stage}-scripts
    DASHBOARDS_TABLE_NAME: ${self:service}-${opt:stage, self:provider.stage}-dashboards
    SETTINGS_TABLE_NAME: ${self:service}-${opt:stage, self:provider.stage}-settings
    MESSAGES_TABLE_NAME: ${self:service}-${opt:stage, self:provider.stage}-messages-v3
    RULES_TABLE_NAME: ${self:service}-${opt:stage, self:provider.stage}-rules

    JWT_SECRET_KEY: ${file(./${opt:stage, self:provider.stage}.env.yml):${opt:stage, self:provider.stage}.JWT_SECRET_KEY}
    BROKER_NAME: ${file(./${opt:stage, self:provider.stage}.env.yml):${opt:stage, self:provider.stage}.BROKER_NAME}
    BROKER_EMAIL: ${file(./${opt:stage, self:provider.stage}.env.yml):${opt:stage, self:provider.stage}.BROKER_EMAIL}
    BROKER_PASSWORD: ${file(./${opt:stage, self:provider.stage}.env.yml):${opt:stage, self:provider.stage}.BROKER_PASSWORD}
    BROKER_URL: ${file(./${opt:stage, self:provider.stage}.env.yml):${opt:stage, self:provider.stage}.BROKER_URL}
    BROKER_PORT: ${file(./${opt:stage, self:provider.stage}.env.yml):${opt:stage, self:provider.stage}.BROKER_PORT}
    WEB_APP_URL: ${file(./${opt:stage, self:provider.stage}.env.yml):${opt:stage, self:provider.stage}.WEB_APP_URL}
    ACCESS_KEY: ${file(./${opt:stage, self:provider.stage}.env.yml):${opt:stage, self:provider.stage}.ACCESS_KEY}
    SECRET_ACCESS_KEY: ${file(./${opt:stage, self:provider.stage}.env.yml):${opt:stage, self:provider.stage}.SECRET_ACCESS_KEY}
    MQTT_URL: ${file(./${opt:stage, self:provider.stage}.env.yml):${opt:stage, self:provider.stage}.MQTT_URL}
    MQTT_HOST: ${file(./${opt:stage, self:provider.stage}.env.yml):${opt:stage, self:provider.stage}.MQTT_HOST}
    MQTT_PORT: ${file(./${opt:stage, self:provider.stage}.env.yml):${opt:stage, self:provider.stage}.MQTT_PORT}

custom:
  dynamodb:
    start:
      port: 8000
      inMemory: false
      migrate: true
    migration:
      dir: offline/migrations

functions:

  auth:
    handler: lib/auth.auth

  #==========================
  # Messages Methods
  #==========================

  MessagesCreate:
    handler : messages/create.create
    events :
      - http: 
         path : messages
         method : post
         private: true
         cors: true
  
  MessagesProcess:
    handler : messages/process.process
    events :
      - http: 
         path : messages/process
         method : post
         private: true
         cors: true
  #==========================
  # Users Methods
  #==========================

  UsersSignup:
    handler: users/signup.signup
    events:
      - http:
          path: users/signup
          method: post
          cors: true

  UsersLogin:
    handler: users/login.login
    events:
      - http:
          path: users/login
          method: post
          cors: true

  UsersForgotPassword:
    handler: users/forgot-password.forgotPassword
    events:
      - http:
          path: users/forgotPassword
          method: post
          cors: true

  UsersResetPassword:
    handler: users/reset-password.resetPassword
    events:
      - http:
          path: users/resetPassword
          method: post
          cors: true

  UsersChangePassword:
    handler: users/change-password.changePassword
    events:
      - http:
          path: users/password
          method: post
          authorizer:
            name: auth
            resultTtlInSeconds: 0
          cors: true

  UsersChangeAuthKey:
    handler: users/change-auth-key.changeAuthKey
    events:
      - http:
          path: users/changeAuthKey
          method: post
          authorizer:
            name: auth
            resultTtlInSeconds: 0
          cors: true

  UsersValidateAuthKey:
    handler: users/validate-auth-key.validateAuthKey
    events:
      - http:
          path: users/validateAuthKey
          method: post
          cors: true
          private: true

  UsersGetProfile:
    handler: users/get-profile.getProfile
    events:
      - http:
          path: users/profile
          method: get
          authorizer:
            name: auth
            resultTtlInSeconds: 0
          cors: true

  UsersChangeProfile:
    handler: users/change-profile.changeProfile
    events:
      - http:
          path: users/profile
          method: post
          authorizer:
            name: auth
            resultTtlInSeconds: 0
          cors: true

  #==========================
  # Devices Methods
  #==========================

  # Create
  DevicesCreate:
    handler: devices/create.create
    events:
      - http:
          path: devices
          method: post
          authorizer:
            name: auth
            resultTtlInSeconds: 0
          cors: true

  # ReadAll
  DevicesReadAll:
    handler: devices/list.listByUser
    events:
      - http:
          path: devices
          method: get
          authorizer:
            name: auth
            resultTtlInSeconds: 0
          cors: true

  # Read
  DevicesGet:
    handler: devices/get.get
    events:
      - http:
          path: devices/{id}
          method: get
          authorizer:
            name: auth
            resultTtlInSeconds: 0
          cors: true

  # Update
  DevicesUpdate:
    handler: devices/update.update
    events:
      - http:
          path: devices/{id}
          method: put
          authorizer:
            name: auth
            resultTtlInSeconds: 0
          cors: true

  # Delete
  DevicesDelete:
    handler: devices/delete.delete
    events:
      - http:
          path: devices/{id}
          method: delete
          authorizer:
            name: auth
            resultTtlInSeconds: 0
          cors: true

  # Update Status
  DevicesUpdateStatus:
    handler: devices/updateStatus.updateStatus
    events:
      - http:
          path: devices/status
          method: POST
          private: true
          cors: true          

  #==========================
  # Scripts Methods
  #==========================

  # Create
  ScriptsCreate:
    handler: scripts/create.create
    events:
      - http:
          path: scripts
          method: post
          authorizer:
            name: auth
            resultTtlInSeconds: 0
          cors: true

  # ReadAll
  ScriptsReadAll:
    handler: scripts/list.listByUser
    events:
      - http:
          path: scripts
          method: get
          authorizer:
            name: auth
            resultTtlInSeconds: 0
          cors: true

  # Read
  ScriptsGet:
    handler: scripts/get.get
    events:
      - http:
          path: scripts/{id}
          method: get
          authorizer:
            name: auth
            resultTtlInSeconds: 0
          cors: true

  # Update
  ScriptsUpdate:
    handler: scripts/update.update
    events:
      - http:
          path: scripts/{id}
          method: put
          authorizer:
            name: auth
            resultTtlInSeconds: 0
          cors: true
          
  # Delete
  ScriptsDelete:
    handler: scripts/delete.delete
    events:
      - http:
          path: scripts/{id}
          method: delete
          authorizer:
            name: auth
            resultTtlInSeconds: 0
          cors: true

  #==========================
  # Dashboards Methods
  #==========================

  # Create
  DashboardsCreate:
    handler: dashboards/create.create
    events:
      - http:
          path: dashboards
          method: post
          authorizer:
            name: auth
            resultTtlInSeconds: 0
          cors: true

  # ReadAll
  DashboardsReadAll:
    handler: dashboards/list.listByUser
    events:
      - http:
          path: dashboards
          method: get
          authorizer:
            name: auth
            resultTtlInSeconds: 0
          cors: true

  # Read
  DashboardsGet:
    handler: dashboards/get.get
    events:
      - http:
          path: dashboards/{id}
          method: get
          authorizer:
            name: auth
            resultTtlInSeconds: 0
          cors: true
      
  # Update
  DashboardsUpdate:
    handler: dashboards/update.update
    events:
      - http:
          path: dashboards/{id}
          method: put
          authorizer:
            name: auth
            resultTtlInSeconds: 0
          cors: true

  # Delete
  DashboardsDelete:
    handler: dashboards/delete.delete
    events:
      - http:
          path: dashboards/{id}
          method: delete
          authorizer:
            name: auth
            resultTtlInSeconds: 0
          cors: true

  #==========================
  # Rules Methods
  #==========================

  # Create
  RulesCreate:
    handler: rules/create.create
    events:
      - http:
          path: rules
          method: post
          authorizer:
            name: auth
            resultTtlInSeconds: 0
          cors: true

  # ReadAll
  RulesReadAll:
    handler: rules/list.listByUser
    events:
      - http:
          path: rules
          method: get
          authorizer:
            name: auth
            resultTtlInSeconds: 0
          cors: true

  # Read
  RulesGet:
    handler: rules/get.get
    events:
      - http:
          path: rules/{id}
          method: get
          authorizer:
            name: auth
            resultTtlInSeconds: 0
          cors: true

  # Update
  RulesUpdate:
    handler: rules/update.update
    events:
      - http:
          path: rules/{id}
          method: put
          authorizer:
            name: auth
            resultTtlInSeconds: 0
          cors: true

  # Delete
  RulesDelete:
    handler: rules/delete.delete
    events:
      - http:
          path: rules/{id}
          method: delete
          authorizer:
            name: auth
            resultTtlInSeconds: 0
          cors: true

  #==========================
  # Share Public Content Methods
  #==========================

  # Get shared script
  ScriptsGetPublic:
    handler: scripts/get-public.getPublic
    events:
      - http:
          path: share/scripts/{id}
          method: get
          cors: true

resources:
  Resources:

    # users dynamodb table resource
    UsersDynamoDBTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${self:provider.environment.USERS_TABLE_NAME}
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: email
            AttributeType: S
          - AttributeName: authKey
            AttributeType: S
          - AttributeName: resetToken
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
        GlobalSecondaryIndexes:
        - IndexName: UsersEmailIndex
          KeySchema:
          - AttributeName: email
            KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 1
            WriteCapacityUnits: 1
        - IndexName: UsersAuthKeyIndex
          KeySchema:
          - AttributeName: authKey
            KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 1
            WriteCapacityUnits: 1
        - IndexName: UsersResetTokenIndex
          KeySchema:
          - AttributeName: resetToken
            KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 1
            WriteCapacityUnits: 1

    # devices dynamodb table resource
    DevicesDynamoDBTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${self:provider.environment.DEVICES_TABLE_NAME}
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: ownerId
            AttributeType: S
          - AttributeName: chipId
            AttributeType: S
        KeySchema:
          - AttributeName: ownerId
            KeyType: HASH
          - AttributeName: id
            KeyType: RANGE
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
        GlobalSecondaryIndexes:
        - IndexName: DevicesChipIdOwnerIdIndex
          KeySchema:
          - AttributeName: chipId
            KeyType: HASH
          - AttributeName: ownerId
            KeyType: RANGE
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 1
            WriteCapacityUnits: 1
    
    # scripts dynamodb table resource
    ScriptsDynamoDBTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${self:provider.environment.SCRIPTS_TABLE_NAME}
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: ownerId
            AttributeType: S
        KeySchema:
          - AttributeName : ownerId
            KeyType: HASH
          - AttributeName: id
            KeyType: RANGE
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
        GlobalSecondaryIndexes:
        - IndexName: ScriptsIdIndex
          KeySchema:
          - AttributeName: id
            KeyType: HASH
          Projection:
            ProjectionType: ALL
          ProvisionedThroughput:
            ReadCapacityUnits: 1
            WriteCapacityUnits: 1

    # dashboards dynamodb table resource
    DashboardsDynamoDBTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${self:provider.environment.DASHBOARDS_TABLE_NAME}
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: ownerId
            AttributeType: S
        KeySchema:
          - AttributeName : ownerId
            KeyType: HASH
          - AttributeName: id
            KeyType: RANGE
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1

    # settings dynamodb table resource
    SettingsDynamoDBTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${self:provider.environment.SETTINGS_TABLE_NAME}
        AttributeDefinitions:
          - AttributeName: name
            AttributeType: S
        KeySchema:
          - AttributeName : name
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1

    #messages dynamodb table resource
    MessagesDynamoDBTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${self:provider.environment.MESSAGES_TABLE_NAME}
        AttributeDefinitions:
          - AttributeName: userIdTopic
            AttributeType: S
          - AttributeName: createdAt
            AttributeType: N
        KeySchema:
          - AttributeName: userIdTopic
            KeyType: HASH
          - AttributeName: createdAt
            KeyType: RANGE
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1

    # rules dynamodb table resource
    RulesDynamoDBTable:
      Type: AWS::DynamoDB::Table
      DeletionPolicy: Retain
      Properties:
        TableName: ${self:provider.environment.RULES_TABLE_NAME}
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: ownerId
            AttributeType: S
        KeySchema:
          - AttributeName : ownerId
            KeyType: HASH
          - AttributeName: id
            KeyType: RANGE
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1

# Keeping packages small by excluding node_modules
package:
  exclude:
    #- node_modules/**
    - lib/node_modules/aws-sdk/**

plugins:
  - serverless-dynamodb-local
  - serverless-offline  
