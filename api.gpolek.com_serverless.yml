---
service: gpolek

provider:
  name: aws
  runtime: ${self:custom.runtime}
  region: ${self:custom.region}
  stage: ${self:custom.stage}
  accountId: ${self:custom.accountId}
  memorySize: ${self:custom.memorySize}
  deploymentBucket: ${self:custom.deploymentBucket}
  role: LambdaRole
  # apiKeys:
  #   - ${self:service}-${self:custom.stage}
  environment:
    emailsTopicArn: ${self:custom.topicPrefix}-emails-topic
    emailsQueueUrl: ${self:custom.queuePrefix}-emails-queue
    email: ${self:custom.email}
    region: ${self:custom.region}
    stage: ${self:custom.stage}

functions:
  authorizeApiRequest:
    handler: handlers/authorize-api-request.handler
  handleApiRequest:
    handler: handlers/handle-api-request.handler
    events:
      - http:
          path: /{proxy+}
          method: ANY
          private: true
          cors:
            origins:
              - '*'
            headers:
              - Content-Type
              - X-Api-Key
            allowCredentials: false
          # authorizer:
          #   name: authorizeApiRequest
          #   resultTtlInSeconds: 0
          #   identitySource: method.request.header.Authorization  # It's one of apiKeys generated by serverless or user from cli
  sendEmails:
    handler: handlers/send-emails.handler
    events:
      - sns: ${self:provider.environment.emailsTopicArn}

resources: ${file(resources.yml)}

custom:
  runtime: ${file(stages/${self:custom.stage}.yml):runtime}
  region: ${opt:region, file(stages/${self:custom.stage}.yml):region}
  vpc: ${opt:vpc, file(stages/${self:custom.stage}.yml):vpc}
  email: ${opt:email, file(stages/${self:custom.stage}.yml):email}
  stage: ${opt:stage}
  project: Grzegorz Polek
  product: API
  accountId: ${file(stages/${self:custom.stage}.yml):accountId}
  memorySize: ${file(stages/${self:custom.stage}.yml):memorySize}
  deploymentBucket: ${file(stages/${self:custom.stage}.yml):deploymentBucket}
  topicPrefix: arn:aws:sns:${self:custom.region}:${self:custom.accountId}:${self:service}-${self:custom.stage}
  queuePrefix: https://sqs.${self:custom.region}.amazonaws.com/${self:custom.accountId}/${self:service}-${self:custom.stage}
